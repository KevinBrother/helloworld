# Nacos å¾®æœåŠ¡æ¶æ„æ¼”ç¤º

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Nacos å¾®æœåŠ¡æ¼”ç¤ºé¡¹ç›®ï¼Œå±•ç¤ºäº†æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ä¾èµ–çš„å®é™…åº”ç”¨ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nacos Server                         â”‚
â”‚              (æœåŠ¡æ³¨å†Œä¸­å¿ƒ & é…ç½®ä¸­å¿ƒ)                    â”‚
â”‚                  http://localhost:8848                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚            â”‚            â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ User  â”‚   â”‚ Order  â”‚   â”‚Payment â”‚   â”‚Gateway â”‚
â”‚Serviceâ”‚   â”‚Service â”‚   â”‚Service â”‚   â”‚Service â”‚
â”‚ 8082  â”‚   â”‚  8081  â”‚   â”‚  8083  â”‚   â”‚  8080  â”‚
â”‚ 8085  â”‚   â”‚        â”‚   â”‚        â”‚   â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚            â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚  â”‚
                â–¼  â–¼
          æœåŠ¡é—´é€šè¿‡ Nacos
          è¿›è¡ŒæœåŠ¡å‘ç°å’Œè°ƒç”¨
```

## ğŸ”— æœåŠ¡ä¾èµ–å…³ç³»

### 1ï¸âƒ£ **è®¢å•æœåŠ¡ (Order Service)**
- **ç«¯å£**: 8081
- **ä¾èµ–**: ç”¨æˆ·æœåŠ¡ (User Service)
- **Nacos ä½œç”¨**:
  - ä» Nacos è·å–ç”¨æˆ·æœåŠ¡çš„å®ä¾‹åˆ—è¡¨
  - é€šè¿‡æœåŠ¡å‘ç°åŠ¨æ€è°ƒç”¨ç”¨æˆ·æœåŠ¡
  - è·å–è®¢å•å…³è”çš„ç”¨æˆ·è¯¦ç»†ä¿¡æ¯

**ä»£ç ç¤ºä¾‹** (`services/order/main.go`):
```go
// ã€Nacos æœåŠ¡å‘ç°ã€‘ä» Nacos è·å–ç”¨æˆ·æœåŠ¡å®ä¾‹åˆ—è¡¨
instances, err := client.SelectInstances(vo.SelectInstancesParam{
    ServiceName: "user-service",
    GroupName:   "DEFAULT_GROUP",
    HealthyOnly: true, // åªè·å–å¥åº·çš„å®ä¾‹
})

// ä½¿ç”¨ç¬¬ä¸€ä¸ªå®ä¾‹è°ƒç”¨ç”¨æˆ·æœåŠ¡
instance := instances[0]
url := fmt.Sprintf("http://%s:%d/user/%d", instance.Ip, instance.Port, userID)
```

### 2ï¸âƒ£ **æ”¯ä»˜æœåŠ¡ (Payment Service)**
- **ç«¯å£**: 8083
- **ä¾èµ–**: è®¢å•æœåŠ¡ (Order Service)
- **Nacos ä½œç”¨**:
  - ä» Nacos è·å–è®¢å•æœåŠ¡çš„å®ä¾‹åˆ—è¡¨
  - æ”¯ä»˜å‰è°ƒç”¨è®¢å•æœåŠ¡éªŒè¯è®¢å•ä¿¡æ¯
  - æ”¯ä»˜å®Œæˆåè°ƒç”¨è®¢å•æœåŠ¡æ›´æ–°è®¢å•çŠ¶æ€

**ä»£ç ç¤ºä¾‹** (`services/payment/main.go`):
```go
// ã€Nacos æœåŠ¡å‘ç°ã€‘ä» Nacos è·å–è®¢å•æœåŠ¡å®ä¾‹åˆ—è¡¨
instances, err := client.SelectInstances(vo.SelectInstancesParam{
    ServiceName: "order-service",
    GroupName:   "DEFAULT_GROUP",
    HealthyOnly: true,
})

// 1. éªŒè¯è®¢å•
order, err := getOrderInfo(namingClient, payment.OrderID)

// 2. æ”¯ä»˜å®Œæˆåæ›´æ–°è®¢å•çŠ¶æ€
err := updateOrderStatus(namingClient, orderID, "paid")
```

### 3ï¸âƒ£ **ç½‘å…³æœåŠ¡ (Gateway Service)**
- **ç«¯å£**: 8080
- **ä¾èµ–**: æ‰€æœ‰åç«¯æœåŠ¡
- **Nacos ä½œç”¨**:
  - ç»Ÿä¸€å…¥å£ï¼Œè·¯ç”±è¯·æ±‚åˆ°å„ä¸ªæœåŠ¡
  - é€šè¿‡ Nacos åŠ¨æ€å‘ç°åç«¯æœåŠ¡

## ğŸ¯ Nacos çš„æ ¸å¿ƒä½œç”¨

### 1. **æœåŠ¡æ³¨å†Œ (Service Registration)**

æ¯ä¸ªæœåŠ¡å¯åŠ¨æ—¶éƒ½ä¼šæ³¨å†Œåˆ° Nacosï¼š

```go
// ã€Nacos æœåŠ¡æ³¨å†Œã€‘
namingClient.RegisterInstance(vo.RegisterInstanceParam{
    Ip:          "127.0.0.1",
    Port:        8081,
    ServiceName: "order-service",
    Weight:      10,
    Enable:      true,
    Healthy:     true,
    Ephemeral:   true,
    GroupName:   "DEFAULT_GROUP",
})
```

**å¥½å¤„**:
- æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
- æœåŠ¡å…³é—­æ—¶è‡ªåŠ¨æ³¨é”€
- æ”¯æŒä¸´æ—¶å®ä¾‹å’ŒæŒä¹…å®ä¾‹

### 2. **æœåŠ¡å‘ç° (Service Discovery)**

æœåŠ¡è°ƒç”¨æ—¶ä» Nacos è·å–ç›®æ ‡æœåŠ¡çš„åœ°å€ï¼š

```go
// ã€Nacos æœåŠ¡å‘ç°ã€‘
instances, err := namingClient.SelectInstances(vo.SelectInstancesParam{
    ServiceName: "user-service",
    GroupName:   "DEFAULT_GROUP",
    HealthyOnly: true, // åªè¿”å›å¥åº·å®ä¾‹
})
```

**å¥½å¤„**:
- æ— éœ€ç¡¬ç¼–ç æœåŠ¡åœ°å€
- æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹
- è‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹
- å®ç°è´Ÿè½½å‡è¡¡

### 3. **é…ç½®ç®¡ç† (Configuration Management)**

é›†ä¸­ç®¡ç†æ‰€æœ‰æœåŠ¡çš„é…ç½®ï¼š

```go
// å‘å¸ƒé…ç½®åˆ° Nacos
configClient.PublishConfig(vo.ConfigParam{
    DataId:  "order-config.yaml",
    Group:   "DEFAULT_GROUP",
    Content: "...",
})

// ç›‘å¬é…ç½®å˜åŒ–
configClient.ListenConfig(vo.ConfigParam{
    DataId: "order-config.yaml",
    Group:  "DEFAULT_GROUP",
    OnChange: func(namespace, group, dataId, data string) {
        // é…ç½®æ›´æ–°æ—¶çš„å›è°ƒ
    },
})
```

**å¥½å¤„**:
- é…ç½®é›†ä¸­ç®¡ç†
- åŠ¨æ€æ›´æ–°é…ç½®
- é…ç½®ç‰ˆæœ¬ç®¡ç†

### 4. **å¥åº·æ£€æŸ¥ (Health Check)**

Nacos å®šæœŸæ£€æŸ¥æœåŠ¡å®ä¾‹çš„å¥åº·çŠ¶æ€ï¼š

- **å¿ƒè·³æœºåˆ¶**: ä¸´æ—¶å®ä¾‹éœ€è¦å®šæœŸå‘é€å¿ƒè·³
- **å¥åº·è¿‡æ»¤**: `HealthyOnly: true` åªè¿”å›å¥åº·å®ä¾‹
- **è‡ªåŠ¨å‰”é™¤**: ä¸å¥åº·çš„å®ä¾‹è‡ªåŠ¨ä»æœåŠ¡åˆ—è¡¨ä¸­ç§»é™¤

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ Nacos

```bash
docker-compose up -d
```

è®¿é—® Nacos æ§åˆ¶å°: http://localhost:8848/nacos  
ç”¨æˆ·å/å¯†ç : `nacos/nacos`

### 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
./start.sh start
```

### 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
./start.sh status
```

### 4. è¿è¡ŒæœåŠ¡ä¾èµ–æ¼”ç¤º

```bash
./service-dependency-demo.sh
```

## ğŸ“‹ æœåŠ¡ä¾èµ–æ¼”ç¤ºæµç¨‹

æ¼”ç¤ºè„šæœ¬ä¼šæŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### æµ‹è¯• 1: è®¢å•æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡

```bash
curl http://localhost:8081/order/1
```

**æµç¨‹**:
1. è®¢å•æœåŠ¡æ¥æ”¶è¯·æ±‚
2. ä» Nacos è·å–ç”¨æˆ·æœåŠ¡å®ä¾‹åˆ—è¡¨
3. è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯
4. è¿”å›è®¢å•å’Œç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯

### æµ‹è¯• 2: æ”¯ä»˜æœåŠ¡ â†’ è®¢å•æœåŠ¡

```bash
curl -X POST http://localhost:8083/payment \
  -H "Content-Type: application/json" \
  -d '{"order_id": 1, "amount": 100.0, "method": "wechat"}'
```

**æµç¨‹**:
1. æ”¯ä»˜æœåŠ¡æ¥æ”¶åˆ›å»ºæ”¯ä»˜è¯·æ±‚
2. ä» Nacos è·å–è®¢å•æœåŠ¡å®ä¾‹åˆ—è¡¨
3. è°ƒç”¨è®¢å•æœåŠ¡éªŒè¯è®¢å•æ˜¯å¦å­˜åœ¨
4. éªŒè¯æ”¯ä»˜é‡‘é¢æ˜¯å¦ä¸è®¢å•é‡‘é¢åŒ¹é…
5. åˆ›å»ºæ”¯ä»˜è®°å½•
6. æ”¯ä»˜å®Œæˆåå†æ¬¡è°ƒç”¨è®¢å•æœåŠ¡æ›´æ–°è®¢å•çŠ¶æ€ä¸º "paid"

### æµ‹è¯• 3: éªŒè¯è®¢å•çŠ¶æ€æ›´æ–°

```bash
curl http://localhost:8081/order/1
```

**éªŒè¯**: è®¢å•çŠ¶æ€åº”è¯¥å·²ç»ä» "pending" æ›´æ–°ä¸º "paid"

### æµ‹è¯• 4: æ”¯ä»˜é‡‘é¢éªŒè¯

```bash
curl -X POST http://localhost:8083/payment \
  -H "Content-Type: application/json" \
  -d '{"order_id": 1, "amount": 999.0, "method": "alipay"}'
```

**é¢„æœŸç»“æœ**: æ”¯ä»˜å¤±è´¥ï¼Œå› ä¸ºé‡‘é¢ä¸åŒ¹é…

## ğŸ“Š æŸ¥çœ‹æœåŠ¡è°ƒç”¨æ—¥å¿—

æŸ¥çœ‹è®¢å•æœåŠ¡æ—¥å¿—ï¼ˆæ˜¾ç¤ºè°ƒç”¨ç”¨æˆ·æœåŠ¡çš„è®°å½•ï¼‰:
```bash
tail -f logs/order.log | grep "ğŸ“"
```

æŸ¥çœ‹æ”¯ä»˜æœåŠ¡æ—¥å¿—ï¼ˆæ˜¾ç¤ºè°ƒç”¨è®¢å•æœåŠ¡çš„è®°å½•ï¼‰:
```bash
tail -f logs/payment.log | grep "ğŸ“"
```

## ğŸ¨ Nacos æ§åˆ¶å°åŠŸèƒ½

è®¿é—® http://localhost:8848/nacos å¯ä»¥ï¼š

1. **æœåŠ¡åˆ—è¡¨**: æŸ¥çœ‹æ‰€æœ‰æ³¨å†Œçš„æœåŠ¡å’Œå®ä¾‹
   - user-service (2ä¸ªå®ä¾‹: 8082, 8085)
   - order-service (1ä¸ªå®ä¾‹: 8081)
   - payment-service (1ä¸ªå®ä¾‹: 8083)
   - gateway-service (1ä¸ªå®ä¾‹: 8080)

2. **æœåŠ¡è¯¦æƒ…**: 
   - å®ä¾‹ IP å’Œç«¯å£
   - å¥åº·çŠ¶æ€
   - æƒé‡é…ç½®
   - å…ƒæ•°æ®ä¿¡æ¯

3. **é…ç½®ç®¡ç†**:
   - æŸ¥çœ‹å„æœåŠ¡çš„é…ç½®
   - åŠ¨æ€ä¿®æ”¹é…ç½®
   - é…ç½®å†å²ç‰ˆæœ¬

4. **å‘½åç©ºé—´**:
   - ç¯å¢ƒéš”ç¦»ï¼ˆdev, test, prodï¼‰
   - å¤šç§Ÿæˆ·ç®¡ç†

## ğŸ”§ ç®¡ç†è„šæœ¬

### start.sh - æœåŠ¡ç®¡ç†è„šæœ¬

```bash
./start.sh start         # å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start.sh stop          # åœæ­¢æ‰€æœ‰æœåŠ¡
./start.sh restart       # é‡å¯æ‰€æœ‰æœåŠ¡
./start.sh status        # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./start.sh logs <service> # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
./start.sh clean         # æ¸…ç†æ—¥å¿—
```

### service-dependency-demo.sh - æœåŠ¡ä¾èµ–æ¼”ç¤º

```bash
./service-dependency-demo.sh  # è¿è¡Œå®Œæ•´çš„ä¾èµ–æ¼”ç¤º
```

## ğŸ’¡ å…³é”®ç‰¹æ€§æ€»ç»“

### ğŸ” åŠ¨æ€æœåŠ¡å‘ç°
- âœ… æ— éœ€ç¡¬ç¼–ç æœåŠ¡åœ°å€
- âœ… æ”¯æŒæœåŠ¡åŠ¨æ€ä¸Šä¸‹çº¿
- âœ… è‡ªåŠ¨è´Ÿè½½å‡è¡¡

### ğŸ¥ å¥åº·æ£€æŸ¥
- âœ… å¿ƒè·³æœºåˆ¶ç›‘æ§æœåŠ¡å¥åº·
- âœ… è‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹
- âœ… åªè·¯ç”±åˆ°å¥åº·å®ä¾‹

### âš–ï¸ è´Ÿè½½å‡è¡¡
- âœ… å¤šå®ä¾‹éƒ¨ç½²ï¼ˆç”¨æˆ·æœåŠ¡æœ‰2ä¸ªå®ä¾‹ï¼‰
- âœ… æƒé‡é…ç½®
- âœ… å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡

### ğŸ”— æœåŠ¡ä¾èµ–
- âœ… æ¸…æ™°çš„æœåŠ¡è°ƒç”¨é“¾è·¯
- âœ… æ”¯ä»˜æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡
- âœ… é€šè¿‡ Nacos è§£è€¦æœåŠ¡ä¾èµ–

### âš™ï¸ é…ç½®ç®¡ç†
- âœ… é›†ä¸­å¼é…ç½®ç®¡ç†
- âœ… åŠ¨æ€é…ç½®æ›´æ–°
- âœ… é…ç½®ç‰ˆæœ¬æ§åˆ¶

## ğŸ“ å­¦ä¹ è¦ç‚¹

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œä½ å¯ä»¥å­¦åˆ°ï¼š

1. **Nacos çš„åŸºæœ¬ä½¿ç”¨**
   - æœåŠ¡æ³¨å†Œä¸å‘ç°
   - é…ç½®ç®¡ç†
   - å¥åº·æ£€æŸ¥

2. **å¾®æœåŠ¡æ¶æ„è®¾è®¡**
   - æœåŠ¡æ‹†åˆ†åŸåˆ™
   - æœåŠ¡ä¾èµ–ç®¡ç†
   - API è®¾è®¡

3. **Go è¯­è¨€å®è·µ**
   - HTTP æœåŠ¡å¼€å‘
   - ç¬¬ä¸‰æ–¹ SDK é›†æˆ
   - å¹¶å‘ç¼–ç¨‹

4. **è¿ç»´å®è·µ**
   - æœåŠ¡éƒ¨ç½²
   - æ—¥å¿—ç®¡ç†
   - ç›‘æ§å‘Šè­¦

## ğŸ“š å‚è€ƒèµ„æ–™

- [Nacos å®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/what-is-nacos.html)
- [Nacos Go SDK](https://github.com/nacos-group/nacos-sdk-go)
- [å¾®æœåŠ¡æ¶æ„æ¨¡å¼](https://microservices.io/patterns/microservices.html)
