# 任务模型系统需求文档

## 1. 项目概述

### 1.1 项目背景

本项目旨在构建一个基于任务状态管理的执行单元调度系统。系统通过任务模型来管理和协调各种执行单元的生命周期，实现任务与执行单元的解耦。

### 1.2 技术栈

- **后端框架**: NestJS
- **编程语言**: TypeScript
- **数据库**: MySQL 8.0+
- **容器化**: Docker & Docker Compose
- **ORM**: TypeORM

## 2. 系统架构设计

### 2.1 核心概念

#### 2.1.1 任务模型 (Task Model)

- 任务是系统中的核心抽象概念
- 负责管理状态转换和生命周期
- 不直接执行具体业务逻辑

#### 2.1.2 执行单元 (Execution Unit)

- 实际执行业务逻辑的组件
- 可以是微服务、函数、脚本等
- 通过任务模型进行调度和管理

### 2.3 执行单元功能案例

以下三个案例充分体现了任务状态流转的完整生命周期和可控性：

#### 2.3.1 数据处理执行单元

**功能描述**: 处理大批量数据文件的转换和清洗
**状态流转特性**:

- **PENDING**: 任务创建后等待分配执行单元
- **RUNNING**: 开始逐批处理CSV数据，实时报告进度
- **PAUSED**: 支持中途暂停，保存当前处理位置
- **RUNNING**: 从暂停点恢复继续处理
- **SUCCESS/FAILED**: 完成处理或遇到不可恢复错误

**可控操作**:

- 启动：分配执行单元开始处理
- 暂停：保存当前进度状态，停止处理
- 恢复：从保存的进度点继续处理
- 取消：停止处理并清理临时文件
- 重启：重新开始整个处理流程

**示例配置**:

```json
{
  "taskType": "DATA_PROCESSING",
  "config": {
    "inputPath": "/data/raw/users.csv",
    "outputPath": "/data/processed/users.json",
    "batchSize": 1000,
    "validationRules": ["email", "phone"],
    "checkpointInterval": 5000
  }
}
```

#### 2.3.2 视频处理执行单元

**功能描述**: 视频文件的转码、压缩和格式转换
**状态流转特性**:

- **PENDING**: 等待视频处理资源分配
- **RUNNING**: 执行视频转码，按帧进度更新
- **PAUSED**: 暂停转码进程，保持临时文件
- **RUNNING**: 恢复转码，从暂停帧继续
- **SUCCESS**: 转码完成，输出最终视频文件
- **FAILED**: 转码失败（格式不支持、磁盘空间不足等）

**可控操作**:

- 启动：开始视频转码处理
- 暂停：暂停转码进程，保存中间状态
- 恢复：从暂停点继续转码
- 取消：终止转码并清理临时文件
- 重启：重新开始转码（清除之前进度）

**示例配置**:

```json
{
  "taskType": "VIDEO_PROCESSING",
  "config": {
    "inputFile": "/videos/source/movie.mp4",
    "outputFile": "/videos/output/movie_compressed.mp4",
    "codec": "h264",
    "bitrate": "2000k",
    "resolution": "1920x1080",
    "enableCheckpoint": true
  }
}
```

#### 2.3.3 数据库备份执行单元

**功能描述**: 执行数据库的备份和恢复操作
**状态流转特性**:

- **PENDING**: 等待数据库连接和备份资源
- **RUNNING**: 执行备份操作，按表或数据量报告进度
- **PAUSED**: 暂停备份（适用于增量备份场景）
- **RUNNING**: 恢复备份操作
- **SUCCESS**: 备份完成，生成校验文件
- **FAILED**: 备份失败（连接中断、磁盘空间不足、权限问题等）

**可控操作**:

- 启动：开始数据库备份流程
- 暂停：暂停备份（保持数据库连接）
- 恢复：继续未完成的备份
- 取消：停止备份并清理不完整文件
- 重启：重新开始完整备份流程

**示例配置**:

```json
{
  "taskType": "DATABASE_BACKUP",
  "config": {
    "dbType": "mysql",
    "host": "localhost:3306",
    "database": "production_db",
    "backupType": "full",
    "outputPath": "/backups/db_backup_20240101.sql",
    "compression": true,
    "verifyIntegrity": true
  }
}
```

### 2.4 状态流转控制机制

每个执行单元都必须实现以下状态控制接口：

```typescript
// 执行单元状态控制接口
interface ExecutionUnitControl {
  // 开始执行
  start(taskId: string, config: any): Promise<void>;
  
  // 暂停执行（保存状态）
  pause(taskId: string): Promise<void>;
  
  // 恢复执行
  resume(taskId: string): Promise<void>;
  
  // 取消执行（清理资源）
  cancel(taskId: string): Promise<void>;
  
  // 获取执行状态和进度
  getStatus(taskId: string): Promise<{
    status: TaskStatus;
    progress: number;
    message?: string;
    checkpoint?: any;
  }>;
}
```

### 2.2 系统分层架构

```
┌─────────────────────────────────────┐
│           API Gateway               │
├─────────────────────────────────────┤
│         Task Controller             │
├─────────────────────────────────────┤
│         Task Service                │
├─────────────────────────────────────┤
│      Task State Manager             │
├─────────────────────────────────────┤
│     Execution Unit Manager          │
├─────────────────────────────────────┤
│         Data Access Layer           │
├─────────────────────────────────────┤
│            MySQL Database           │
└─────────────────────────────────────┘
```

## 3. 任务状态模型

### 3.1 任务状态定义

| 状态 | 英文名称 | 描述 | 可转换状态 |
|------|----------|------|------------|
| 等待 | PENDING | 任务已创建，等待执行 | RUNNING, CANCELLED |
| 运行 | RUNNING | 任务正在执行中 | SUCCESS, FAILED, PAUSED, CANCELLED |
| 成功 | SUCCESS | 任务执行成功完成 | - |
| 失败 | FAILED | 任务执行失败 | PENDING (重启) |
| 暂停 | PAUSED | 任务被暂停执行 | RUNNING, CANCELLED |
| 取消 | CANCELLED | 任务被取消 | PENDING (重启) |

### 3.2 状态转换图

```
    CREATE
      ↓
   PENDING ←──────────────┐
      ↓                   │
   RUNNING ←──────────────┤
   ↓  ↓  ↓                │
SUCCESS FAILED PAUSED ────┤
   ↓     ↓     ↓          │
   END   ↓   RUNNING ─────┤
         ↓                │
      PENDING ────────────┘
         ↓
    CANCELLED
         ↓
        END
```

## 4. 任务操作定义

### 4.1 操作列表

#### 4.1.1 创建任务 (CREATE)

- **描述**: 创建新任务实例
- **初始状态**: PENDING
- **参数**: 任务类型、配置参数、优先级等

#### 4.1.2 启动任务 (START)

- **描述**: 启动等待中的任务
- **状态转换**: PENDING → RUNNING
- **触发**: 分配执行单元并开始执行

#### 4.1.3 暂停任务 (PAUSE)

- **描述**: 暂停正在运行的任务
- **状态转换**: RUNNING → PAUSED
- **触发**: 通知执行单元暂停执行

#### 4.1.4 取消任务 (CANCEL)

- **描述**: 取消任务执行
- **状态转换**: PENDING/RUNNING/PAUSED → CANCELLED
- **触发**: 释放执行单元资源

#### 4.1.5 重启任务 (RESTART)

- **描述**: 重新启动失败或取消的任务
- **状态转换**: FAILED/CANCELLED → PENDING
- **触发**: 重置任务状态并重新调度

#### 4.1.6 删除任务 (DELETE)

- **描述**: 删除任务记录
- **前置条件**: 任务必须处于终态 (SUCCESS/FAILED/CANCELLED)
- **触发**: 清理相关资源和数据

## 5. 数据库设计

### 5.1 任务表 (tasks)

```sql
CREATE TABLE tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_name VARCHAR(255) NOT NULL,
    task_type VARCHAR(100) NOT NULL,
    status ENUM('PENDING', 'RUNNING', 'SUCCESS', 'FAILED', 'PAUSED', 'CANCELLED') NOT NULL DEFAULT 'PENDING',
    priority INT DEFAULT 0,
    config JSON,
    execution_unit_id VARCHAR(255),
    execution_unit_type VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    error_message TEXT,
    retry_count INT DEFAULT 0,
    max_retries INT DEFAULT 3,
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_task_type (task_type)
);
```

### 5.2 任务状态历史表 (task_status_history)

```sql
CREATE TABLE task_status_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL,
    from_status VARCHAR(50),
    to_status VARCHAR(50) NOT NULL,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    changed_by VARCHAR(255),
    reason TEXT,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_changed_at (changed_at)
);
```

### 5.3 执行单元表 (execution_units)

```sql
CREATE TABLE execution_units (
    id VARCHAR(255) PRIMARY KEY,
    unit_type VARCHAR(100) NOT NULL,
    unit_name VARCHAR(255) NOT NULL,
    status ENUM('AVAILABLE', 'BUSY', 'OFFLINE') NOT NULL DEFAULT 'AVAILABLE',
    capacity INT DEFAULT 1,
    current_load INT DEFAULT 0,
    endpoint VARCHAR(500),
    config JSON,
    last_heartbeat TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_unit_type (unit_type)
);
```

## 6. API 设计

### 6.1 任务管理 API

#### 6.1.1 创建任务

```typescript
POST /api/tasks
{
  "taskName": "数据处理任务",
  "taskType": "DATA_PROCESSING",
  "priority": 1,
  "config": {
    "inputPath": "/data/input",
    "outputPath": "/data/output"
  },
  "maxRetries": 3
}
```

#### 6.1.2 启动任务

```typescript
POST /api/tasks/{taskId}/start
```

#### 6.1.3 暂停任务

```typescript
POST /api/tasks/{taskId}/pause
```

#### 6.1.4 取消任务

```typescript
POST /api/tasks/{taskId}/cancel
```

#### 6.1.5 重启任务

```typescript
POST /api/tasks/{taskId}/restart
```

#### 6.1.6 删除任务

```typescript
DELETE /api/tasks/{taskId}
```

#### 6.1.7 查询任务

```typescript
GET /api/tasks/{taskId}
GET /api/tasks?status=RUNNING&page=1&limit=10
```

### 6.2 执行单元管理 API

#### 6.2.1 注册执行单元

```typescript
POST /api/execution-units
{
  "unitType": "DOCKER_CONTAINER",
  "unitName": "data-processor-1",
  "capacity": 5,
  "endpoint": "http://processor:8080",
  "config": {}
}
```

#### 6.2.2 心跳检测

```typescript
POST /api/execution-units/{unitId}/heartbeat
```

## 7. 核心服务实现

### 7.1 任务状态管理器

```typescript
@Injectable()
export class TaskStateManager {
  private readonly stateTransitions = new Map([
    ['PENDING', ['RUNNING', 'CANCELLED']],
    ['RUNNING', ['SUCCESS', 'FAILED', 'PAUSED', 'CANCELLED']],
    ['PAUSED', ['RUNNING', 'CANCELLED']],
    ['FAILED', ['PENDING']],
    ['CANCELLED', ['PENDING']]
  ]);

  async transitionState(
    taskId: number,
    fromState: TaskStatus,
    toState: TaskStatus,
    reason?: string
  ): Promise<void> {
    // 验证状态转换是否合法
    // 更新任务状态
    // 记录状态变更历史
    // 触发相应的执行单元操作
  }
}
```

### 7.2 执行单元管理器

```typescript
@Injectable()
export class ExecutionUnitManager {
  async allocateUnit(taskType: string): Promise<ExecutionUnit> {
    // 根据任务类型和负载情况分配执行单元
  }

  async executeTask(unit: ExecutionUnit, task: Task): Promise<void> {
    // 向执行单元发送任务执行指令
  }

  async pauseTask(unit: ExecutionUnit, taskId: number): Promise<void> {
    // 向执行单元发送暂停指令
  }

  async cancelTask(unit: ExecutionUnit, taskId: number): Promise<void> {
    // 向执行单元发送取消指令
  }
}
```

## 8. 执行单元接口规范

### 8.1 执行单元必须实现的接口

#### 8.1.1 执行任务

```typescript
POST /execute
{
  "taskId": 123,
  "taskType": "DATA_PROCESSING",
  "config": {}
}
```

#### 8.1.2 暂停任务

```typescript
POST /pause/{taskId}
```

#### 8.1.3 取消任务

```typescript
POST /cancel/{taskId}
```

#### 8.1.4 查询任务状态

```typescript
GET /status/{taskId}
```

### 8.2 执行单元回调接口

#### 8.2.1 任务状态更新

```typescript
POST /api/tasks/{taskId}/status
{
  "status": "SUCCESS",
  "result": {},
  "errorMessage": null
}
```

## 9. Docker 部署配置

### 9.1 docker-compose.yml

```yaml
version: '3.8'

services:
  task-manager:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USERNAME=taskmanager
      - DB_PASSWORD=password
      - DB_DATABASE=task_management
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=task_management
      - MYSQL_USER=taskmanager
      - MYSQL_PASSWORD=password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  execution-unit-example:
    build: ./execution-units/example
    environment:
      - TASK_MANAGER_URL=http://task-manager:3000
    depends_on:
      - task-manager

volumes:
  mysql_data:
```

### 9.2 Dockerfile

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "run", "start:prod"]
```

## 10. 监控和日志

- 使用 winston 日志库，做文件存储的的日志

### 10.1 监控指标

- 任务执行成功率
- 任务平均执行时间
- 执行单元利用率
- 系统吞吐量
- 错误率统计

### 10.2 日志记录

- 任务状态变更日志
- 执行单元操作日志
- 系统错误日志
- 性能监控日志

## 11. 暂不考虑扩展性考虑

## 12. 安全性

### 12.1 暂不使用认证授权

### 12.2 暂不考虑数据安全

### 13.1 需要单元测试

- 状态转换逻辑测试
- 执行单元管理测试
- API 接口测试

### 13.2 不需要集成测试

### 13.3 不需要性能测试

## 14. 实施计划

### 14.1 第一阶段 (2周)

- 基础项目结构搭建
- 数据库设计和初始化
- 核心任务模型实现

### 14.2 第二阶段 (2周)

- 任务状态管理器实现
- 基础 API 开发
- Docker 环境配置

### 14.3 第三阶段 (2周)

- 执行单元管理器实现
- 示例执行单元开发

### 14.4 第四阶段 (1周)

- 完善单元测试
- 文档完善

这个需求文档详细描述了如何通过任务状态来管理执行单元，实现了任务与执行逻辑的解耦，为后续的开发提供了清晰的指导。
