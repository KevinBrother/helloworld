# Crawlee æµ‹è¯•é©±åŠ¨å­¦ä¹ é¡¹ç›®

## é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªçº¯æµ‹è¯•é©±åŠ¨çš„ Crawlee å­¦ä¹ é¡¹ç›®ã€‚é€šè¿‡ç¼–å†™å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹æ¥å­¦ä¹ å’ŒéªŒè¯ Crawlee æ¡†æ¶çš„å„ç§åŠŸèƒ½ç‰¹æ€§ï¼Œè€Œä¸æ˜¯æ„å»ºå®é™…çš„çˆ¬è™«åº”ç”¨ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- æŒæ¡ Crawlee çš„æ ¸å¿ƒ API å’ŒåŠŸèƒ½
- ç†è§£çˆ¬è™«çš„å¹¶å‘æ§åˆ¶å’Œæ€§èƒ½ä¼˜åŒ–
- å­¦ä¼šä½¿ç”¨ Playwright è¿›è¡Œæµè§ˆå™¨è‡ªåŠ¨åŒ–
- ç†Ÿæ‚‰æ•°æ®å­˜å‚¨ã€ç¼“å­˜å’Œå»é‡æœºåˆ¶
- é€šè¿‡ TDD æ–¹å¼æ·±åº¦å­¦ä¹ æ¡†æ¶ç‰¹æ€§

## ğŸ—ï¸ æµ‹è¯•æ¶æ„

```
tests/
â”œâ”€â”€ helpers/           # æµ‹è¯•å·¥å…·ç±»
â”‚   â”œâ”€â”€ mock-server.ts # Mock HTTP æœåŠ¡å™¨
â”‚   â””â”€â”€ test-utils.ts  # æµ‹è¯•è¾…åŠ©å‡½æ•°
â”œâ”€â”€ unit/             # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ basic-crawler.test.ts          # åŸºç¡€çˆ¬è™«åŠŸèƒ½
â”‚   â”œâ”€â”€ browser-automation.test.ts     # æµè§ˆå™¨è‡ªåŠ¨åŒ–
â”‚   â”œâ”€â”€ performance-optimization.test.ts # æ€§èƒ½ä¼˜åŒ–
â”‚   â””â”€â”€ deduplication-caching.test.ts  # å»é‡å’Œç¼“å­˜
â”œâ”€â”€ integration/      # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ full-crawl-flow.test.ts       # å®Œæ•´çˆ¬å–æµç¨‹
â””â”€â”€ setup.test.ts     # ç¯å¢ƒè®¾ç½®æµ‹è¯•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–
```bash
pnpm install
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
pnpm test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
```bash
# åŸºç¡€çˆ¬è™«åŠŸèƒ½æµ‹è¯•
pnpm test:run tests/unit/basic-crawler.test.ts

# æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•
pnpm test:run tests/unit/browser-automation.test.ts

# æ€§èƒ½ä¼˜åŒ–æµ‹è¯•
pnpm test:run tests/unit/performance-optimization.test.ts

# å»é‡å’Œç¼“å­˜æµ‹è¯•
pnpm test:run tests/unit/deduplication-caching.test.ts

# å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•
pnpm test:run tests/integration/full-crawl-flow.test.ts
```

### ç›‘è§†æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
```bash
pnpm test:watch
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
pnpm test:coverage
```

## ğŸ“š æµ‹è¯•å†…å®¹è¯¦è§£

### 1. åŸºç¡€çˆ¬è™«åŠŸèƒ½ (basic-crawler.test.ts)
- âœ… é¡µé¢è¯·æ±‚å’Œå“åº”å¤„ç†
- âœ… HTML å†…å®¹æå–å’Œè§£æ
- âœ… é“¾æ¥å‘ç°å’Œè·Ÿè¸ª
- âœ… è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
- âœ… æ•°æ®å­˜å‚¨ï¼ˆDatasetï¼‰

### 2. æµè§ˆå™¨è‡ªåŠ¨åŒ– (browser-automation.test.ts)
- âœ… æ— å¤´æµè§ˆå™¨æ“ä½œ
- âœ… JavaScript æ¸²æŸ“å¤„ç†
- âœ… è¡¨å•å¡«å†™å’Œæäº¤
- âœ… é¡µé¢æˆªå›¾åŠŸèƒ½
- âœ… Cookie å’Œä¼šè¯ç®¡ç†

### 3. æ€§èƒ½ä¼˜åŒ– (performance-optimization.test.ts)
- âœ… å¹¶å‘è¯·æ±‚æ§åˆ¶
- âœ… è¯·æ±‚é™æµå’Œé€Ÿç‡æ§åˆ¶
- âœ… å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- âœ… é”™è¯¯é‡è¯•æœºåˆ¶
- âœ… ä¼šè¯æ± ç¼“å­˜ç­–ç•¥

### 4. å»é‡å’Œç¼“å­˜ (deduplication-caching.test.ts)
- âœ… URL è‡ªåŠ¨å»é‡æœºåˆ¶
- âœ… é¡µé¢å†…å®¹ç¼“å­˜å¤ç”¨
- âœ… è¯·æ±‚æŒ‡çº¹å»é‡
- âœ… æ™ºèƒ½ç¼“å­˜ç­–ç•¥

### 5. å®Œæ•´çˆ¬å–æµç¨‹ (full-crawl-flow.test.ts)
- âœ… ç”µå•†ç½‘ç«™å®Œæ•´çˆ¬å–
- âœ… æ•°æ®å­˜å‚¨å’Œç»Ÿè®¡
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•
- âœ… çˆ¬å–æŠ¥å‘Šç”Ÿæˆ

## ğŸ”§ æµ‹è¯•å·¥å…·è¯´æ˜

### MockServer
æä¾›å¯æ§çš„æµ‹è¯•ç¯å¢ƒï¼Œæ¨¡æ‹Ÿå„ç§ç½‘ç«™åœºæ™¯ï¼š
```typescript
const mockServer = new MockServer({
  port: 3000,
  responses: {
    '/product/1': {
      status: 200,
      body: '<html>...</html>'
    }
  }
});
```

### TestCrawlerHelper
ç®€åŒ–æµ‹è¯•è®¾ç½®å’Œæ¸…ç†ï¼š
```typescript
await withMockServer(async (helper) => {
  const crawler = new PlaywrightCrawler({...});
  await crawler.run([helper.getServerUrl()]);
});
```

## ğŸ“Š æµ‹è¯•è¿è¡Œç¤ºä¾‹

è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼š
```bash
$ pnpm test:run tests/unit/basic-crawler.test.ts

âœ“ åŸºç¡€çˆ¬è™«åŠŸèƒ½ (Core)
  âœ“ åŸºæœ¬é¡µé¢è¯·æ±‚å’Œå“åº”å¤„ç†
    âœ“ åº”è¯¥èƒ½å¤Ÿè®¿é—®é¡µé¢å¹¶è·å–æ ‡é¢˜
    âœ“ åº”è¯¥èƒ½å¤Ÿå¤„ç†å¤šä¸ªURLè¯·æ±‚
  âœ“ HTMLå†…å®¹æå–å’Œè§£æ
    âœ“ åº”è¯¥èƒ½å¤Ÿæå–é¡µé¢å…ƒç´ å†…å®¹
    âœ“ åº”è¯¥èƒ½å¤Ÿæå–äº§å“é¡µé¢ä¿¡æ¯
  âœ“ é“¾æ¥å‘ç°å’Œè·Ÿè¸ª
    âœ“ åº”è¯¥èƒ½å¤Ÿå‘ç°å¹¶è·Ÿè¸ªé¡µé¢é“¾æ¥
    âœ“ åº”è¯¥èƒ½å¤Ÿè¿‡æ»¤å’Œé™åˆ¶è·Ÿè¸ªçš„é“¾æ¥
  âœ“ è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
    âœ“ åº”è¯¥èƒ½å¤Ÿæ‰‹åŠ¨ç®¡ç†è¯·æ±‚é˜Ÿåˆ—
    âœ“ åº”è¯¥èƒ½å¤Ÿå¤„ç†è¯·æ±‚ä¼˜å…ˆçº§
  âœ“ æ•°æ®å­˜å‚¨ (JSON/CSVæ ¼å¼)
    âœ“ åº”è¯¥èƒ½å¤Ÿä¿å­˜æ•°æ®åˆ°Dataset
    âœ“ åº”è¯¥èƒ½å¤Ÿè·å–æ•°æ®é›†ä¿¡æ¯
    âœ“ åº”è¯¥èƒ½å¤Ÿå¤„ç†å¤§é‡æ•°æ®

Test Files  1 passed (1)
Tests      11 passed (11)
Duration   4.19s
```

## ğŸ“ˆ å­¦ä¹ è·¯å¾„å»ºè®®

### é˜¶æ®µä¸€ï¼šåŸºç¡€åŠŸèƒ½ (1-2å¤©)
1. è¿è¡Œ `tests/setup.test.ts` ç†Ÿæ‚‰ç¯å¢ƒ
2. å­¦ä¹  `tests/unit/basic-crawler.test.ts` çš„åŸºç¡€API
3. ç†è§£ PlaywrightCrawlerã€Datasetã€RequestQueue ä½¿ç”¨

### é˜¶æ®µäºŒï¼šè¿›é˜¶åŠŸèƒ½ (2-3å¤©)
1. è¿è¡Œ `tests/unit/browser-automation.test.ts` å­¦ä¹ æµè§ˆå™¨æ§åˆ¶
2. è¿è¡Œ `tests/unit/performance-optimization.test.ts` å­¦ä¹ æ€§èƒ½è°ƒä¼˜
3. æŒæ¡å¹¶å‘æ§åˆ¶ã€é‡è¯•æœºåˆ¶ã€ä¼šè¯ç®¡ç†

### é˜¶æ®µä¸‰ï¼šé«˜çº§ç‰¹æ€§ (2-3å¤©)
1. è¿è¡Œ `tests/unit/deduplication-caching.test.ts` å­¦ä¹ å»é‡ç¼“å­˜
2. è¿è¡Œ `tests/integration/full-crawl-flow.test.ts` ç†è§£å®Œæ•´æµç¨‹
3. å­¦ä¹ å®é™…åº”ç”¨åœºæ™¯çš„å¤„ç†æ–¹æ³•

## ğŸ¨ è‡ªå®šä¹‰æµ‹è¯•

ä½ å¯ä»¥åŸºäºç°æœ‰çš„æµ‹è¯•æ¡†æ¶ç¼–å†™è‡ªå·±çš„æµ‹è¯•ç”¨ä¾‹ï¼š

```typescript
import { describe, it, expect } from 'vitest';
import { PlaywrightCrawler } from 'crawlee';
import { withMockServer } from '../helpers/test-utils';

describe('æˆ‘çš„è‡ªå®šä¹‰æµ‹è¯•', () => {
  it('åº”è¯¥èƒ½å¤Ÿå¤„ç†ç‰¹å®šåœºæ™¯', async () => {
    await withMockServer(async (helper) => {
      const crawler = new PlaywrightCrawler({
        requestHandler: async ({ page, request }) => {
          // ä½ çš„æµ‹è¯•é€»è¾‘
        }
      });
      
      await crawler.run([helper.getServerUrl()]);
      // éªŒè¯ç»“æœ
    });
  });
});
```

## ğŸ” è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ `DEBUG=crawlee:*`
2. **ä½¿ç”¨ç›‘è§†æ¨¡å¼**ï¼š`pnpm test:watch` å®æ—¶æŸ¥çœ‹æµ‹è¯•ç»“æœ
3. **å•ç‹¬è¿è¡Œæµ‹è¯•**ï¼šä½¿ç”¨ `.only()` åªè¿è¡Œç‰¹å®šæµ‹è¯•
4. **æŸ¥çœ‹æµè§ˆå™¨**ï¼šè®¾ç½® `headless: false` è§‚å¯Ÿæµè§ˆå™¨è¡Œä¸º

## ğŸ“ æ³¨æ„äº‹é¡¹

- æ‰€æœ‰æµ‹è¯•éƒ½åœ¨éš”ç¦»ç¯å¢ƒä¸­è¿è¡Œï¼Œä¸ä¼šå½±å“çœŸå®ç½‘ç«™
- æµ‹è¯•ä¼šè‡ªåŠ¨æ¸…ç†åˆ›å»ºçš„æ•°æ®ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
- Mock æœåŠ¡å™¨æ¨¡æ‹Ÿå„ç§ç½‘ç«™åœºæ™¯ï¼Œç¡®ä¿æµ‹è¯•ç¨³å®šæ€§
- æµ‹è¯•è¦†ç›–äº† Crawlee çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†ä¸åŒ…æ‹¬æ‰€æœ‰è¾¹ç¼˜æƒ…å†µ

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹æ¥è¦†ç›–æ›´å¤šçš„ Crawlee åŠŸèƒ½ï¼è¯·éµå¾ªç°æœ‰çš„æµ‹è¯•ç»“æ„å’Œå‘½åçº¦å®šã€‚

## ğŸ“š ç›¸å…³èµ„æº

- [Crawlee å®˜æ–¹æ–‡æ¡£](https://crawlee.dev/)
- [Playwright æ–‡æ¡£](https://playwright.dev/)
- [Vitest æ–‡æ¡£](https://vitest.dev/)
- [åŠŸèƒ½å®ç°æ¸…å•](./FEATURE_CHECKLIST.md)